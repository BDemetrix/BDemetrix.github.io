class Tooltips{constructor(t={}){this.attach=t.attach??".smart-tooltip",this.mobileAttach=t.mobileAttach,this.openTrigger=t.openTrigger??"mouseenter",this.closeTrigger=t.closeTrigger??"mouseleave",this.content=t.content??"title",this.beforeOpen=t.beforeOpen,this.onOpen=t.onOpen,this.onClose=t.onClose,this.contentSource=t.contentSource??null,this.setContent=t.setContent??null,this.setContentOnce=t.setContentOnce??!1,this.awaitDone=t.awaitDone??!1,this.popover=t.popover??!1,this.offset=t.offset??"",this.hasPointer=t.hasPointer??!0,this.pointerSize=t.pointerSize??"",this.maxWidth=t.maxWidth??null,this.width=t.width??null,this.posMod={},this.posMod.x=t.posMod?.x??"center",this.posMod.y=t.posMod?.y??"auto",this.hMargin=t.hMargin??10,this.textAlign=t.textAlign??"",this.theme=t.theme,this.addClass=t.addClass??null,this.timeout=t.timeout??500,this.closeTimeout=t.closeTimeout??400,this.attachCursorXPos=t.attachCursorXPos??1.3,this.attachCursorYPos=t.attachCursorYPos??!1,this.loader=t.loader??'<div class="spinner-loader spinner-loader--p0" role="status">\n                                      <div class="spinner-loader__ring"></div>\n                                      <span class="spinner-loader__label">Загружаем...</span>\n                                    </div>',this.closeBlocked=!1,this.contentLoading=!1,this.presetPosMod={...this.posMod},this.classMod={},this.isOpen=!1,this.isFirstOpen=!0,this.fetchedConntent=null,this.borderRadius=0,this.mouseEnterThis=!1,this.isTouch="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,this.mainOpenTriggerListenersCB=[],this.mainCloseTriggerListenersCB=[],this.removeTimerListenersCB=[],this._init()}_init(){if("none"===this.mobileAttach&&this.isTouch)console.info(`Тултипы для селектора ${this.attach} на тачскринах отключены опцией {mobileAttach: 'none'}`);else{if(this.mobileAttach&&this.isTouch&&(this.attach=this.mobileAttach),this.attach instanceof NodeList||Array.isArray(this.attach))this.targets=this.attach;else{if("string"!=typeof this.attach)throw`Параметр "attach" = ${this.attach}, должен быть экземпляром NodeList либо строкой`;this.targets=document.querySelectorAll(this.attach)}if(!this.targets.length)throw`Не найдены ноды по селектору ${this.attach}`;if(this.el=document.createElement("div"),this.el.className="js-tooltip",this.el.innerHTML='<div class="js-tooltip__container"></div> <div class="js-tooltip__pointer js-tooltip__pointer--bottom"></div>',document.body.append(this.el),this.container=this.el.querySelector(".js-tooltip__container"),null!==this.addClass&&this.container.classList.add(this.addClass),this.pointer=this.el.querySelector(".js-tooltip__pointer"),this.theme&&this.el.classList.add(`js-tooltip-${this.theme}`),this.popover&&"mouseleave"==this.closeTrigger&&(this.el.addEventListener("mouseenter",this._setHoverPopoverFlag.bind(this),!1),this.el.addEventListener("mouseleave",this._closePopoverOnMouseOut.bind(this),!1)),this.el.addEventListener("click",this._closeTooltipOnBtnClick.bind(this),!1),this.contentSource&&"string"==typeof this.contentSource){const t=document.querySelector(this.contentSource);if(!t)throw`По селектору ${this.contentSource} не найден блок для наполнения тултипа`;this.contentSourceEl=t}this.isTouch&&(this.openTrigger="click"),this.targets.forEach((t=>{t.classList.add("js-tooltip-target"),"title"===this.content&&(t.dataset[this.content]=t.getAttribute(this.content)??"",t.removeAttribute(this.content),this.maxWidth??=280,this.el.style.maxWidth=this.maxWidth+"px");const e=this._mainOpenTriggerListener.bind(this);if(this.mainOpenTriggerListenersCB.push(e),t.addEventListener(this.openTrigger,e,!1),"click"===this.openTrigger&&(this.closeTrigger="click"),"mouseleave"===this.closeTrigger){const e=this._mainCloseTriggerListener.bind(this);this.mainCloseTriggerListenersCB.push(e),t.addEventListener(this.closeTrigger,e,!1)}const s=this._removeTimerOnMouseOut.bind(this);this.removeTimerListenersCB.push(s),t.addEventListener("mouseleave",s,!1)})),("mouseleave"!==this.closeTrigger||this.popover)&&document.documentElement.addEventListener("click",this._closeTooltipOutsideTargetClick.bind(this),!1),window.addEventListener("resize",this._closeTooltipOnResize.bind(this),!1),this._setProperty()}}async _beforeOpen(t,e){if(!this.beforeOpen||"function"!=typeof this.beforeOpen)return!0;try{return await this.beforeOpen(t,e)}catch(t){return console.error(t),!1}}_mainOpenTriggerListener(t){console.log("_mainOpenTriggerListener");const e=t.target;if(this.target=e,"click"===t.type&&this.closeTrigger==t.type){if(this.isOpen)return;t.stopPropagation()}if("mouseenter"===t.type)return clearTimeout(this.closeTimer),this.popover&&this.parentTarget===e?void(this.mouseEnterThis=!1):(this.popover&&(this.parentTarget=e),void(this.openTimer=setTimeout((()=>{this.open(e,t)}),this.timeout)));this.mouseEnterThis=!1,this.prevClickTarget!=e?(this.prevClickTarget=e,this.open(e,t)):this._close()}_mainCloseTriggerListener(){this.popover?this.closeTimer=setTimeout((()=>{this.parentTarget=null,this._close()}),this.closeTimeout):this._close()}_removeTimerOnMouseOut(t){clearTimeout(this.openTimer)}_setHoverPopoverFlag(t){console.log("setHoverPopoverFlag"),console.log(this),clearTimeout(this.closeTimer),this.mouseEnterThis=!0}_closePopoverOnMouseOut(t){console.log("closePopoverOnMouseOut"),console.log(this),this.isOpen&&(this.closeTimer=setTimeout((()=>{this.mouseEnterThis=!1,this.parentTarget=null,this._close()}),this.closeTimeout))}_closeTooltipOnBtnClick(t){t.target.closest(".js-tooltip-close-btn")&&(this.mouseEnterThis=!1,this._close())}_closeTooltipOutsideTargetClick(t){t.target.closest(".js-tooltip__container")||this.isOpen&&t.target.closest(".js-tooltip-target")==this.target||(this.mouseEnterThis=!1,this.prevClickTarget=null,this.isOpen&&this._close())}_closeTooltipOnResize(t){this.mouseEnterThis=!1,this.isOpen&&this._close()}destroy(){this.targets.forEach(((t,e)=>{t.removeEventListener(this.openTrigger,this.mainOpenTriggerListenersCB[e]),t.removeEventListener("mouseleave",this.removeTimerListenersCB[e]),"mouseleave"===this.closeTrigger&&this.mainCloseTriggerListenersCB.length&&t.removeEventListener(this.closeTrigger,this.mainCloseTriggerListenersCB[e])})),this.popover&&"mouseleave"==this.closeTrigger&&(this.el.removeEventListener("mouseenter",this._setHoverPopoverFlag),this.el.removeEventListener("mouseleave",this._closePopoverOnMouseOut)),this.el.removeEventListener("click",this._closeTooltipOnBtnClick),("mouseleave"!==this.closeTrigger||this.popover)&&document.documentElement.removeEventListener("click",this._closeTooltipOutsideTargetClick),window.removeEventListener("resize",this._closeTooltipOnResize),this.openTimer&&clearTimeout(this.openTimer),this.closeTimer&&clearTimeout(this.closeTimer),this.el.remove();for(let t in this)this.hasOwnProperty(t)&&(delete this[t],console.log(t+": "+this[t]));let t=this;setTimeout((()=>{t=null}),0)}_open(t,e){this._calcPos(t,e),this._modClasses(),this.show(),"function"!=typeof this.onOpen||this.contentLoading||this.onOpen(t,e)}async open(t,e){this.mouseEnterThis=!1;if(!await this._beforeOpen(t,e)||this.closeBlocked)return;this.target;let s="";if(this.setContent&&"function"==typeof this.setContent)this.setContentOnce&&this.fetchedConntent?s=this.fetchedConntent:(s=`<div class="js-tooltip__content">${this.loader}</div>`,this._setContent(t,e));else if(this.setContent&&"string"==typeof this.setContent)s=`<div class="js-tooltip__content">${this.setContent}</div>`;else if(this.contentSourceEl)s=this.contentSourceEl.outerHTML;else if("title"===this.content){const e=t.getAttribute("data-title")??"";s=e?`<div class="js-tooltip__content">${e}</div>`:null}else this.content&&(s=this.content);s?(this.container.innerHTML=s,this._open(t,e)):console.error('Контент тултипа не задан! \nСледует задать одно из свойств: setContent, content, contentSource в конструкторе new Tooltips() \nлибо заполнить атрибут "title" у целевых элементов')}close(){this.mouseEnterThis=!1,this.closeBlocked=!1,this._close()}_close(){this.mouseEnterThis||this.closeBlocked||(this.prevClickTarget=null,this.hide(),this._clearPos(),"function"!=typeof this.onClose||this.contentLoading||this.onClose())}show(){this.el&&this.el.classList.add("js-tooltip--shown"),this.isOpen=!0}hide(){this.el&&this.el.classList.remove("js-tooltip--shown"),this.isOpen=!1}async _setContent(t,e){if(!this.setContent||"function"!=typeof this.setContent||this.contentLoading)return;this.closeBlocked=this.awaitDone,this.contentLoading=!0;try{this.fetchedConntent=await this.setContent(t)}catch(e){console.error(e)}this.closeBlocked=!1,this.mouseEnterThis=!1;const s=this.isOpen;this._close(),this.contentLoading=!1,this.fetchedConntent?(this.container.innerHTML=this.fetchedConntent,this.setContentOnce||(this.fetchedConntent=null),s&&setTimeout((()=>{this._open(t,e)}),200)):console.error("Контент не загрузился!")}_calcPos(t,e){const s=document.documentElement.clientWidth,i=t.getBoundingClientRect();this.hasPointer&&(this.pointer.style.left="");const o=window.scrollY;let n=this.el.offsetWidth,h=this.el.offsetHeight+(this.isFirstOpen?this.offset:0);this.isFirstOpen=!1;const r="number"==typeof this.attachCursorXPos&&i.width>n*this.attachCursorXPos;this.posMod.x=r?"cursor-x-pos-auto":this.presetPosMod.x;let l=0,a=0;this.attachCursorYPos&&(l=e.pageY-o-i.top,a=i.bottom-(e.pageY-o));let c="auto",p="auto",d="auto",u="auto";i.top<h&&"auto"===this.posMod.y||"under"===this.posMod.y?(()=>{this.classMod.y="under",c=Math.ceil(i.bottom-a+o)})():(()=>{this.classMod.y="above",c=Math.ceil(i.top+l-h+o)})();const g=()=>Math.ceil(i.left-(n-i.width)/2),m=()=>g()+n;var T=(t="")=>{if(u="auto","auto"===t&&g()<this.hMargin)return v();m();return i.right<n-this.hMargin&&(u=this.hMargin),this.hasPointer&&n>i.width&&setTimeout((()=>{this.pointer.style.left=this.el.offsetWidth-Math.max(i.width/2+this.pointerSize,this.borderRadius)+"px"}),50),p=s-i.right},v=(t="")=>(p="auto","auto"===t&&m()>s-this.hMargin?T():(i.left+n>s-this.hMargin&&(p=this.hMargin+"px"),this.hasPointer&&n>i.width&&setTimeout((()=>{this.pointer.style.left=Math.max(i.width/2-this.pointerSize,this.borderRadius)+"px"}),50),u=i.left));const f=()=>{p="auto";const t=g();return m()>s-this.hMargin?T():t<this.hMargin?v():u=t};switch(this.posMod.x){case"left":v();break;case"left-auto":v("auto");break;case"right":T();break;case"right-auto":T("auto");break;case"cursor-x-pos-auto":(()=>{const t=e.pageX,s=n/2;u=t>i.right-s?i.right-n:t>i.left+s?t-n/2:i.left})();break;default:f()}this.el.style.top="string"==typeof c?c:c+"px",this.el.style.right="string"==typeof p?p:p+"px",this.el.style.bottom=d,this.el.style.left="string"==typeof u?u:u+"px"}_clearPos(){this.el&&(this.el.style.top="",this.el.style.right="",this.el.style.bottom="",this.el.style.left="")}_modClasses(){switch(this.el.classList.remove("js-tooltip--top","js-tooltip--bottom"),this.pointer.classList.remove("js-tooltip__pointer--top","js-tooltip__pointer--bottom"),this.classMod.y){case"above":this.el.classList.add("js-tooltip--top"),this.pointer.classList.add("js-tooltip__pointer--bottom");break;case"under":this.el.classList.add("js-tooltip--bottom"),this.pointer.classList.add("js-tooltip__pointer--top")}}_setProperty(){this.offset?this.el.style.setProperty("--offset",this.offset):this.offset=parseFloat(window.getComputedStyle(this.el).getPropertyValue("--offset"))??12,this.hasPointer?this.pointerSize?this.el.style.setProperty("--pointer-size",this.pointerSize+"px"):this.pointerSize=parseFloat(window.getComputedStyle(this.el).getPropertyValue("--pointer-size"))??"":this.pointer.style.display="none",this.textAlign&&(this.el.style.textAlign=this.textAlign),this.maxWidth&&(this.el.style.maxWidth="string"==typeof this.maxWidth?this.maxWidth:this.maxWidth+"px"),this.width&&(this.el.style.width="string"==typeof this.width?this.width:this.width+"px"),this.borderRadius=parseFloat(window.getComputedStyle(this.container).borderRadius)??0}}